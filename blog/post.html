<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Blog Post – Ai-Auto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Read about AI automation and productivity tips from Ai-Auto.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Playfair+Display:wght@500;600;700;900&display=swap" rel="stylesheet">
  <!-- Load Quill CSS before custom styles for proper cascade -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/components/blog.css">
</head>

<body>
  <!-- BLOG POST -->
  <section class="blog-post-container">
    <div class="blog-post-wrapper">
      <!-- Loading state -->
      <div class="blog-loading" id="postLoading">
        <div class="blog-loading-spinner"></div>
        <p>Loading blog post...</p>
      </div>

      <!-- Blog post content will be loaded here -->
      <div id="blogPostContent"></div>
    </div>
  </section>

  <!-- BLOG NAVIGATION -->
  <nav class="blog-nav" id="blogNavigation" style="display: none;">
    <a href="../blog.html" class="blog-nav-link">← Back to Blog</a>
    <a href="#" class="blog-nav-link" id="nextPostLink" style="display: none;">Next Post →</a>
  </nav>





  <!-- Scripts -->
  <!-- Navigation Component -->
  <script src="../js/components/navigation.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../supabase.js"></script>
  <script>
    // Blog post functionality
    class BlogPost {
      constructor() {
        this.postContent = document.getElementById('blogPostContent');
        this.loading = document.getElementById('postLoading');
        this.navigation = document.getElementById('blogNavigation');
        this.nextPostLink = document.getElementById('nextPostLink');
        this.slug = this.getSlugFromUrl();
        this.allPosts = [];
        this.currentPostIndex = 0;
        this.init();
      }

      getSlugFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('slug');
      }

      async init() {
        if (!this.slug) {
          this.showError('No blog post specified.');
          return;
        }

        try {
          await this.loadBlogPost();
          await this.loadNextPostLink();
        } catch (error) {
          this.showError('Failed to load blog post. Please try again later.');
        }
      }

      async loadBlogPost() {
        const { data, error } = await blogManager.getPostBySlug(this.slug);
        
        if (error) {
          throw error;
        }

        if (!data) {
          this.showNotFound();
          return;
        }

        this.renderBlogPost(data);
        this.updateSEO(data);
      }

      renderBlogPost(post) {
        const date = new Date(post.published_at || post.created_at).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        // Content is already HTML from Quill editor
        const renderedContent = post.content;

        // Include featured image if available
        const featuredImageHtml = post.featured_image
          ? `<img src="${post.featured_image}" alt="${this.escapeHtml(post.title)}" class="blog-featured-image" />`
          : '';

        const postHTML = `
          <article class="blog-post-header">
            <h1 class="blog-post-title-main">${this.escapeHtml(post.title)}</h1>
            <div class="blog-post-meta-main">
              <span class="blog-post-date">${date}</span>
              <span class="blog-post-author">By Admin</span>
            </div>
          </article>

          ${featuredImageHtml}

          <article class="blog-post-content ql-editor">
            ${renderedContent}
          </article>
        `;

        this.hideLoading();
        this.postContent.innerHTML = postHTML;
        this.navigation.style.display = 'flex';
      }

      updateSEO(post) {
        // Update page title
        document.title = `${post.title} – Ai-Auto Blog`;

        // Update meta description
        const metaDescription = document.querySelector('meta[name="description"]');
        if (metaDescription) {
          const excerpt = post.excerpt || this.createExcerpt(post.content);
          metaDescription.content = excerpt;
        }

        // Update Open Graph tags
        this.updateMetaTag('og:title', post.title);
        this.updateMetaTag('og:description', post.excerpt || this.createExcerpt(post.content));
        this.updateMetaTag('og:type', 'article');
        this.updateMetaTag('og:url', window.location.href);

        // Add featured image to Open Graph if available
        if (post.featured_image) {
          this.updateMetaTag('og:image', post.featured_image);
          this.updateMetaTag('og:image:width', '1200');
          this.updateMetaTag('og:image:height', '630');
        }
      }

      updateMetaTag(property, content) {
        let tag = document.querySelector(`meta[property="${property}"]`) || 
                   document.querySelector(`meta[name="${property}"]`);
        
        if (!tag) {
          tag = document.createElement('meta');
          tag.setAttribute(property.includes('og:') ? 'property' : 'name', property);
          document.head.appendChild(tag);
        }
        
        tag.content = content;
      }

      async loadNextPostLink() {
        try {
          // Get all published posts
          const { data: allPosts } = await blogManager.getAllPosts();

          if (!allPosts || allPosts.length === 0) {
            return;
          }

          this.allPosts = allPosts;

          // Find the current post index
          this.currentPostIndex = allPosts.findIndex(post => post.slug === this.slug);

          // If there's a next post, show the link
          if (this.currentPostIndex !== -1 && this.currentPostIndex < allPosts.length - 1) {
            const nextPost = allPosts[this.currentPostIndex + 1];
            this.nextPostLink.style.display = 'inline-flex';
            this.nextPostLink.href = `post.html?slug=${nextPost.slug}`;
            this.nextPostLink.textContent = `Next Post: ${nextPost.title} →`;
          }
        } catch (error) {
          console.error('Error loading next post link:', error);
        }
      }

      createExcerpt(content, maxLength = 160) {
        // Strip HTML tags and formatting to create plain text excerpt
        let stripped = content
          .replace(/<[^>]*>/g, '') // Remove HTML tags
          .trim();
        return stripped.length > maxLength
          ? stripped.substring(0, maxLength) + '...'
          : stripped;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      hideLoading() {
        this.loading.style.display = 'none';
      }

      showError(message) {
        this.hideLoading();
        this.postContent.innerHTML = `
          <div class="blog-error">
            <div class="blog-error-box">
              <h3>Oops! Something went wrong</h3>
              <p>${message}</p>
            </div>
          </div>
        `;
      }

      showNotFound() {
        this.hideLoading();
        this.postContent.innerHTML = `
          <div class="blog-error">
            <div class="blog-error-box">
              <h3>Blog Post Not Found</h3>
              <p>The blog post you're looking for doesn't exist or has been removed.</p>
              <a href="../blog.html" class="btn" style="margin-top: var(--space-md);">Back to Blog</a>
            </div>
          </div>
        `;
      }
    }

    // Initialize blog post when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      new BlogPost();
    });

  </script>

</body>

</html>
